name: Build Android JRE (aarch64)

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-android-jre.yml'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config gawk gperf make cmake zip unzip curl xz-utils python2 git ccache zlib1g-dev

      - name: Download NDK r10e
        run: |
          cd $RUNNER_TEMP
          curl -L -o ndk.zip https://dl.google.com/android/ndk/android-ndk-r10e-linux-x86_64.zip
          unzip -q ndk.zip
          echo "ANDROID_NDK_HOME=$RUNNER_TEMP/android-ndk-r10e" >> $GITHUB_ENV

      - name: Clone Android OpenJDK build scripts
        run: |
          git clone --depth=1 https://github.com/PojavLauncherTeam/android-openjdk-build-multiarch.git build-android-jdk

      - name: Force NDK to use Python 2 (needed on Ubuntu 22.04)
        run: |
          sed -i 's@/usr/bin/env python@/usr/bin/env python2@' "$ANDROID_NDK_HOME/build/tools/make-standalone-toolchain.sh" || true
          sed -i 's/\<python\>/python2/g' "$ANDROID_NDK_HOME/build/tools/make-standalone-toolchain.sh" || true

      - name: Build JDK 17 (aarch64)
        working-directory: build-android-jdk
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          TARGET: aarch64-linux-android
          TARGET_JDK: aarch64
          ANDROID_API_LEVEL: 21
          JDK_DEBUG_LEVEL: release
          JVM_VARIANTS: server
          BUILD_FREETYPE_VERSION: 2.10.4
          JDK_MAJOR: 17
          PYTHON: /usr/bin/python2
        run: |
          set -euxo pipefail
          ./extractndk.sh
          ./maketoolchain.sh
          ./getlibs.sh
          ./buildlibs.sh
          ./clonejdk.sh
          ./buildjdk.sh
          ./removejdkdebuginfo.sh
          ./tarjdk.sh
          ls -lah out || true
          ls -lah images || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jre-aarch64-jdk17
          path: |
            build-android-jdk/out/**
            build-android-jdk/images/**
